---
title: "MetProcesser1.0.3 Instruction"
author: "Xiaotao Shen (shenxt@sioc.ac.cn); Zhengjiang Zhu"
date: "September 25th, 2016"
output: html_document
---

####**Introduction**
#####The MetProcesser package provides an integrated pipeline for large scale mass spectrometry based metabolomics data pre-processing and statistical analysis. It includes zero filtering, missing value filtering, missing value imputation, data normalization, data integration, data quality assessment, univariate statistical analysis, multivariate statistical analysis such as PCA and PLS-DA, potential marker selection and potential marker show. This document describes how to use the function included in the R package MetProcesser using demo data.

![](workflow of MetProcesser.png)

#### (1)**Install MetProcesser**
#####**MetProcesser is published in Github, so you can install it form Github. You must install R package devtools first.**

```{r, eval= FALSE}
 install.packages("devtools")
 library(devtools)
 install_github("jaspershen/MetProcesser", ref = "version1.0.3")
```

#### (2)**The help document of MetProcesser**
```{r, eval = FALSE}
help(package = "MetProcesser")
```

#### (3)**Data organization**
#####The data and sample information should be placed in a folderï¼š

![](data organization.png)

#####1. "data.csv" is the data you want to process, and row is feature and column is sample or tag of feature. The tags of feature must contains "name" (feature name), "mz" (mass to change ratio) and "rt" (retention time). Other tags of feature are optional, for example "isotopes" and "adducts". The name of sample can contain ".", but can not contain "_"" , "-" or " " (space). And the head of sample name can not be number. For example, "A210.a" and "A210a" are valid, and "210a" or "210-a" are invalid.

![](data.png)

#####2. "sample.information.csv" are sample information. Column 1 is "sample.name" which are the names of subject and QC sample. Please confirm that the sample name in "sample.information.csv" and "data.csv" are completely same. Column 2 is "injection.order" which is the injection order of QC and subject sample. Column 3 is "class", which is used to distinguish "QC" and "Subject". Column 4 is "batch". Column 5 is "group", which is used to label the group of subject sample. For example, "control" and "case". The group of QC is labeled as "QC".

![](sample.information.png)

#####3. "peak identification" are optional. If your data have no identification information, you can use the identification information of QC to match your data according to mz and RT. Please create the folder named "peak identification" and place QC MSMS information in this folder. **Please note that each MSMS information name should contain "ms2" label**.

![](peak identification.png)

####(4)**Data pre-processing**
#####Use the demo data of MetProcesser as example.
#####(1)Set work directory

```{r, eval = FALSE}
##demo data
data(data, package = "MetProcesser")
data(sample.information, package = "MetProcesser")
data(ms2_50_300, package = "MetProcesser")
data(ms2_50_1200, package = "MetProcesser")
data(ms2_290_600, package = "MetProcesser")
data(ms2_590_900, package = "MetProcesser")
##demo work directory
dir.create("Demo for MetProcesser")
setwd("Demo for MetProcesser")
path <- file.path(getwd(), "peak identification")
dir.create(path)
##write files
write.csv(data, "data.csv", row.names = FALSE)
write.csv(sample.information , "sample.information.csv", row.names = FALSE)
write.csv(sample.information , "new.group.csv", row.names = FALSE)
write.csv(ms2_50_300, file.path(path, "ms2_50_300.csv"), row.names = FALSE)
write.csv(ms2_50_1200, file.path(path, "ms2_50_1200.csv"), row.names = FALSE)
write.csv(ms2_290_600, file.path(path, "ms2_290_600.csv"), row.names = FALSE)
write.csv(ms2_590_900, file.path(path, "ms2_590_900.csv"), row.names = FALSE)
```

#####(2)Import data

```{r, eval=FALSE}
MetFlowData <- ImportData(data = "data.csv",
                          sample.information = "sample.information.csv",
                          polarity = "positive")
```

######MetFlowData is a standard class which can be processed in MetProcesser. You can see the information of it through typing it or printing it.

```{r, eval=FALSE}
MetFlowData
print(MetFlowData)
```

#####(3)Missing value filtering and imputation. (If there are no missing values, this step can be skipped)
#####Use MVOverview function to investigate the missing values in data.

```{r, eval=FALSE}
MVOverview(MetFlowData = MetFlowData, path = "MV overview")
```

#####A new folder named "MV overview" is created:

![](MV overview1.png)

#####"MV overview" contains the missing value information of each batch:

![](MV overview2.png)

#####Use MVFilter to filter missing values.

```{r, eval=FALSE}
MetFlowData <- MVFilter(MetFlowData = MetFlowData,
                        obs.mv.per.cutoff = 0.5,
                        var.mv.per.cutoff = 0.5,
                        path = "MV filter")
```

#####MVFilter filter missing values according the missing value ratio in each feature and sample. If the missing value ratio of one feature in subject samples or QC samples larger than the cutoff (default is 50%), this feature would be removed from the data. And if the missing value ratio of one subject or QC sample larger than the cutoff (default is 50%), this sample also would be removed from the data.  

![](MV filter.png)

#####Missing value imputation

```{r, eval=FALSE}
MetFlowData <- MVimputation(MetFlowData = MetFlowData,
                            #MV imputation method
                            imputation.method = "knn",
                            #knn parameters
                            k = 10,
                            rowmax = 0.5,
                            colmax = 0.8,
                            maxp = 1500)
```

#####(4)Zero filtering
#####Use ZeroOverview function to investigate the zero in data.

```{r, eval=FALSE}
ZeroOverview(MetFlowData = MetFlowData, path = "Zero overview")
```

#####A new folder named "Zero overview" is created:

![](Zero overview1.png)

#####"Zero overview" contains the zero value information of each batch:

![](Zero overview2.png)

#####Use ZeroFilter function to filter zero values:

```{r, eval=FALSE}
MetFlowData <- ZeroFilter(MetFlowData = MetFlowData,
                          obs.zero.per.cutoff = 0.5,
                          var.zero.per.cutoff = 0.5,
                          path = "Zero filter")
```

#####ZeroFilter filter missing values according the zero value ratio in each feature and sample. If the zero value ratio of one feature in subject samples or QC samples larger than the cutoff (default is 50%), this feature would be removed from the data. And if the zero value ratio of one subject or QC sample larger than the cutoff (default is 50%), this sample also would be removed from the data.  

![](Zero filter.png)

#####(5)Label the outliers in QC samples (PCA score plot).
#####Use QCOutlierFinder function to find outliers in QC samples.

```{r, eval=FALSE}
qc.outlier.data <- QCOutlierFinder(MetFlowData = MetFlowData,
                                   CI = 0.95,
                                   path = "QC outlier finder")
MetFlowData <- qc.outlier.data[["MetFlowData"]]
```

#####A new folder named "QC outlier finder" is created, it contains QC outliers for each batch:

![](QC outlier finder1.png)

#####The QC samples which are outside the 95% confidence interval in PCA score plot are considered as outliers, and are labeled as red color:

![](QC outlier finder2.png)

#####(6)Use MetabolitePlot function to investigate the change for each feature in different batches. (If there is only one batch, this step can be skipped)

```{r, eval=FALSE}
MetabolitePlot(MetFlowData = MetFlowData,
               path = "metabolite plot before integration")
```

#####(7)Data normalization. (Default is SVR normalization)

```{r, eval=FALSE}
MetFlowData <- DataNormalization(MetFlowData = MetFlowData,
                                method = "svr",
                                threads = 2)
```

#####A new folder named "Normalization result" is created, it contains the normalization for each batch:

![](Normalization1.png)

#####Data normalization for each batch:

![](Normalization2.png)

![](Normalization3.png)

#####(8)Label outliers in subject sample. (PCA score plot)
#####Use SubjectOutlierFinder function to find outliers in subject samples.

```{r, eval=FALSE}
subject.outlier.data <- SubjectOutlierFinder(MetFlowData = MetFlowData,
                                             CI = 0.95,
                                             path = "Subject outlier finder")
MetFlowData <- subject.outlier.data[["MetFlowData"]]
```

#####A new folder named "Subject outlier finder" is created, it contains outliers in each batch:

![](Subject outlier finder1.png)

#####The subject sample which outside 95% confidence interval in PCA score plot are considered as outliers and are labeled as red color:

#####(9)Peak identification. (Data with identification information can skip this step)

```{r, eval=FALSE}
MetFlowData <- PeakIdentification(MetFlowData = MetFlowData,
                                  #parameters for matching
                                  mz.tolerance = 25,
                                  rt.tolerance = 180)
```

#####A new folder named "matching result" is created in "peak identification", it contains the identification result, and the identification results are also added in to tags.

![](peak identification2.png)

#####"identification.information.txt" record some identification information.

![](peak identification3.png)

#####(10)Use BatchEffectOverview function to investigate batch effect. (If there is only one batch, this step can be skipped)

```{r, eval=FALSE}
BatchEffectOverview(MetFlowData = MetFlowData,
                   path = "Batch effect before integration")
```

#####The PCA score plot of QC, subject sample and the total intensity of QC samples are used to show batch effect:

![](batch effect before integration1.png)
![](batch effect before integration2.png)
![](batch effect before integration4.png)

#####(11)Use RSDoverview function to investigate the RSD distribution before data integration:

```{r, eval=FALSE}
RSDoverview(MetFlowData = MetFlowData,
            path = "RSD overview before integration")
```


#####(12)Data integration. (If there is only one batch, this step can be skipped)

```{r, eval=FALSE}
MetFlowData <- DataIntegration(MetFlowData = MetFlowData)
```

#####(13)Use BatchEffectOverview function to investigate batch effect. (If there is only one batch, this step can be skipped)

```{r, eval=FALSE}
BatchEffectOverview(MetFlowData = MetFlowData,
                   path = "Batch effect after integration")
```

#####(14)USe MetabolitePlot function to investigate the change for each feature in different batched. (If there is only one batch, this step can be skipped)

```{r, eval=FALSE}
MetabolitePlot(MetFlowData = MetFlowData,
               path = "metabolite plot after integration")
```

#####(15)Use RSDoverview function to investigate the RSD distribution after data integration.

```{r, eval=FALSE}
RSDoverview(MetFlowData = MetFlowData,
              path = "RSD overview after integration")
```

#####(16)Use DataOverview to investigate the data.

```{r, eval=FALSE}
DataOverview(MetFlowData = MetFlowData,
             feature.distribution = TRUE,
             path = "Data overview")
```

#####"Data overview.txt" record some base information of data.

![](data overview1.png)

#####"Data overview_RT vs mz vs intensity.pdf" shows the distribution of features:

![](data overview2.png)

#####(17)Output data into csv files.

```{r, eval=FALSE}
OutputMetFlowData(MetFlowData = MetFlowData,
                  data.name = "data_after_pre",
                  subject.info.name = "subject.info",
                  qc.info.name = "qc.info",
                  path = NULL)
```

#####Data are outputted as "data_after_pre.csv", "subject.info.csv" and "qc.info.csv":

![](data output.png)


*********************************
####(5)**Statistical analysis**
#####The data after pre-processing can be used to do statistical analysis.
#####(1)Give new group information. If the group information in "sample.information.csv" are not right or appropriate, we can use ReChangeGroup function to change new group information in data. Change the group information in "sample.information.csv" and name it as "new.group.csv", and place it in this folder.

![](new.group.png)

```{r, eval = FALSE}
MetFlowData <- ReChangeGroup(MetFlowData = MetFlowData)
```

#####(2) PCA analysis

```{r, eval = FALSE}
PCAanalysis(MetFlowData = MetFlowData,
            QC = TRUE,
            scale.method = "auto",
            path = "PCA analysis")
```

#####(3)PLS analysis

```{r, eval = FALSE}
PLSanalysis(MetFlowData = MetFlowData,
            #used data
            scalemethod="auto",
            path = "PLS analysis")
```

#####Analysis results are placed in "PLS analysis" folder:

![](pls analysis.png)

```{r, eval = FALSE}
MetFlowData <- ReChangeGroup(MetFlowData = MetFlowData)
```

#####(4)Calculate the fold change for two group data.

```{r, eval = FALSE}
MetFlowData <- FoldChange(MetFlowData = MetFlowData,
                          to = c("case", "control"),
                          ratio = "median")
```

#####(5)Univariate test for two group data.
```{r, eval = FALSE}
MetFlowData <- UnivariateTest(MetFlowData = MetFlowData,
                              test.method = "t",
                              adjust.method = "fdr")
```

#####(6)Select potential biomarkers according to fold chang and p value.

```{r, eval = FALSE}
MetFlowData <- MarkerSelection(MetFlowData = MetFlowData,
                               foldchange = "foldchange",
                               p = "p",
                               foldchange.cutoff = c(4/3, 3/4),
                               p.cutoff = 0.05,
                               path = "marker selection")
```

#####(7)Volcano plot

```{r, eval = FALSE}
VolcanoPlot(MetFlowData = MetFlowData,
            foldchange = "foldchange",
            p = "p",
            col = c("black", "firebrick1"),
            foldchange.cutoff = c(4/3, 3/4),
            p.cutoff = 0.05,
            path = "marker selection")
```

![](volcanoplot.png)

#####(8)Draw box plot for potential markers.

```{r, eval = FALSE}
MarkerShow(MetFlowData = MetFlowData,
           beeswarm = T,
           path = "marker selection")
```

#####(9)Output data as csv files.

```{r, eval = FALSE}
OutputMetFlowData(MetFlowData = MetFlowData,
                  data.name = "data_after_Stat",
                  subject.info.name = "subject.info",
                  qc.info.name = "qc.info",
                  path = NULL)
```

---
####**You can use MetPre to do all pre-processing for data.**

```{r, eval = FALSE}
MetPre(#ImportData para
       data = "data.csv",
       sample.information = "sample.information.csv",
       polarity = "positive",
       #DataNormalization
       method = "svr",
       threads = 2)
```

####**You can use MetStat to do all statistical analysis for data.**

```{r, eval = FALSE}
  MetStat(MetFlowData = MetFlowData,
          new.group = TRUE,
          #PCA analysis para
          QC = TRUE,
          scale.method = "auto",
          #FoldChange para
          to = c("case", "control"),
          ratio = "median",
          #UnivariateTest para
          test.method = "t",
          adjust.method = "fdr",
          #MarkerSelection para
          foldchange = "foldchange",
          p = "p",
          foldchange.cutoff = c(4/3, 3/4),
          p.cutoff = 0.05,
          #MarkerShow para
          beeswarm = TRUE)
```


